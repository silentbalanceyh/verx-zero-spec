ifndef::imagesdir[:imagesdir: ../images]
:data-uri:

=== Ansible环境初始化

==== 基本步骤

新版Zero使用了Ansible为开发人员准备一致性开发环境，但基础准备工作需要在此处特殊说明，开发环境的Ansible执行流程图如下：

image::workflow-dev.png[Fork,1280]

Ansible基本准备工作如下：

1. 目标机器（开发环境本地，生产环境服务器）需配置三个核心命令：mysql、mvn、java（开发环境初始化只需要mysql，java、mvn为将来准备着）。
2. 由于Ansible使用登录方式为Non Shell，所以上述三个核心命令的配置需要配置在目标机器的 *~/.bashrc* 环境变量文件中，如：

+
--
[source,bash]
----
# Ansible ------------------------------------------------------------------
# Ansible Java
export JAVA_HOME=/Library/Java/JavaVirtualMachines/zulu-17.jdk/Contents/Home
export CLASSPATH=.
export PATH=$PATH:$JAVA_HOME/bin
# Ansible Homebrew
# - MySQL, Maven .....
export PATH=$PATH:/opt/homebrew/bin
----
--

3. 再执行 *ansible* 命令的机器配置 /etc/ansible/hosts 设置需操作的主机信息，如：

+
--
[source,toml]
----
[zero]
ox.engine.cn            # 该地址也已经写入本机host中：127.0.0.1 -> ox.engine.cn
----
--

[TIP]
====
从流程图上可知，前半部分 *账号初始化、库初始化* 在生产环境和开发环境是一致的，都是使用SSH登录到目标机器执行脚本（Windows会重新开发），后半部分 *表初始化、数据初始化* 在开发环境使用 liquibase、iac-load.jar 直接执行，而在生产环境则会将初始化内容打包成发布专用的SQL文件，直接执行。
====

==== 插件指令程序

上述流程中有一个后期指令集的功能，但图上只列举了常用的数据导入部分，开发过程中现阶段支持三个指令程序：

[TIP]
====
iac 的全称：Infrastructure As Code，inst 的全称：单词指令：Instruction 的缩写。

插件指令程序是为当前应用做所有容器启动前的预处理配置专用，一旦数据库准备好之后，您就可以直接运行所有的插件指令程序完成所需的操作。
====

[options="header",cols="30,70"]
|====
|名称|说明
|inst-load.jar|配置数据导入器，负责所有现存配置数据的导入流程。
|inst-atom.jar|建模管理器，负责所有动态建模数据的导入（需在环境变量中设置：`DB_ATOM=true` ）。
|inst-menu.jar|菜单规划器，负责所有菜单的重命名、排序、父子级连接。
|====

有了 *菜单规划器* 之后，新版本的程序导入不需要导入菜单中的 `ORDER（排序）、PARENT_ID（父子级关系）、TEXT（菜单名称）、LEVEL（菜单等级）` 等核心字段，这样Excel配置文件中的菜单数据就彻底被简化了。