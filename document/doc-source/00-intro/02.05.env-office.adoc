ifndef::imagesdir[:imagesdir: ../images]
:data-uri:

=== 办公协同

Zero Ui中的办公协同，主要针对Office的套件（ `Word, Excel, PPT` ）进行在线的协同浏览/编辑，集成了开源版的 link:https://www.onlyoffice.com/[ONLYOFFICE] 套件，此套件依赖后端运行一个特殊的**文档服务器**，所以本文提供**开发**和**生产场景**下的服务器搭建流程，让开发人员可以完善扩展模块 `zero-is / zero-doc` 的**文档管理**以及**文档阅览**功能。

- 参考：link:https://helpcenter.onlyoffice.com/installation.aspx[安装首页]
- 参考：link:https://helpcenter.onlyoffice.com/installation/docs-community-index.aspx[`Community` 版本安装]

根据您自身操作系统需求选择对应的安装教程：

image:zero-doc-server-install.png[,800]

==== 基本介绍

在搭建**文档服务器**之前先看看 ONLYOFFICE 产品线（ `Community / Enterprise / Developer` 三种版本）：

[options="header", cols="2,8"]
|====
|产品名|含义
|`Docs` |提供平台使用的**文档编辑器**，可以和内置的**文档服务器**集成（本章内容）。
|`DocSpace` |提供**文档协同**专用的在线办公室，侧重于工具。
|`Workspace` |工作空间，您可以在这个空间中做项目管理，直接和项目管理强相关的工作区间。
|`Connectors` |和其他平台集成用的**连接器**。
|`Apps` |各种不同平台对应的终端。
|====

ONLYOFFICE 产品线上会包含 `Document Server` 以及 `Community Server` 两个服务端，这两个服务端的区别在于：

- `Document Server`：直接和内置 `Docs` 工具集成专用提供编辑器的服务器，编辑器包括：
+
--
- `Document Editor`：编辑 Word 文档专用。
- `Spreadsheet Editor`：编辑 Excel 文档专用。
- `Presentation Editor`：编辑 PPT 文档专用。
- `Form Creator`：表单编辑器。
- `PDF reader / converter`：PDF阅读器和转换器。
--
- `Community Server`：集成专用服务器，提供了 `REST` 的 API 接口。

其他额外的内容参考：link:https://api.onlyoffice.com/[ONLYOFFICE文档中心]。

教程中主要使用第一个开源产品 `ONLYOFFICE Docs`，它是一个开源办公套件，包含了**文本文档（Word）、电子表格（Excel）、演示文稿（PPT）**的编辑器，功能点如下：

- 创建、编辑、查看对应的**文本文档（Word）、电子表格（Excel）、演示文稿（PPT）**。
- 和其他团队成员协同处理文档。
- 查看PDF、导入/导出PDF。
- 将文档转换成 Markdown / HTML 等相关格式。
- 将课本转化成电子书。

====
从 `6.4` 版本开始，`Docs` 提供了对 Web 应用程序开放平台接口协议（ `WOPI` ）的支持（一种 REST 协议），用于将您的应用程序和在线办公室集成，它允许您打开存储在服务器上的文件、编辑、保存它们。

它支持的所有格式包括：`DOC, DOCX, ODT, RTF, TXT, PDF, HTML, EPUB, XPS, DjVu, XLS, XLSX, ODS, CSV, PPT, PPTX, ODP`。
====

==== Docker安装

[TIP]
====
Docker默认指定了 Google DNS 服务器，若您无法从互联网访问，则您需要修改Docker的DNS设置保证您可以访问镜像服务器，如常见的Linux的配置位于 `/etc/default/docker` 文件中，有几种方法可以解决这个问题：

_命令方式_

在启动命令中使用 `docker_OPTS="--dns 8.8.8.8"` 参数。

_基于 RPM 的系统_：

1. 创建配置文件 `/etc/docker/daemon.json` 文件，配置内容如下：
+
--
[source,json]
----
{
    "dns": [ "8.8.8.8" ]
}
----
--
2. 重启Docker服务
+
--
[source,bash]
----
sudo systemctl restart docker.service
----
--

====

===== 基本命令

若安装了Docker，那么您可以使用如下命令启动：

[source,bash]
----
# 有必要追加 sudo
# 直接启动
docker run -i -t -d -p 5600:80 --restart=always -e JWT_SECRET=my_jwt_secret onlyoffice/documentserver:latest

# 您可以先试用如下命令单拉镜像（省掉运行时的镜像拉取时间）
docker pull onlyoffice/documentserver:latest
----

从 `7.2` 的版本开始，若您没有指定 `JWT_SECRET` 参数，系统会随机生成，且切换虚拟机（VM）和物理机启动时会重新生成，这会给集成带来一定的问题，所以此处最好您直接使用自定义的值：

- 使用JWT：`-e JWT_SECRET=xxxx`。
- 关闭JWT：`-e JWT_ENABLED=false`。

===== 存储分离

ONLYOFFICE 中的所有数据都是存储在指定目录中的：

[options="header", cols="4,6"]
|====
|目录|含义
|`/var/log/onlyoffice` |存储 ONLYOFFICE Docs 的日志数据
|`/var/www/onlyoffice/Data` |存储证书信息
|`/var/lib/onlyoffice` |文件缓存
|`/var/lib/postgresql` |数据库文件
|====

若您想要将这些数据存储到容器之外，您可以使用 `-v` 选项，最终执行命令如下（端口号使用 `31017` ）：

[source,bash]
----
# 生成自己的 my_jwt_secret，直接使用 ai str -n 1 -l 36
ai str -n 1 -l 36
# 假设：OaBgxq6UYs6IWBSHdUlMswUDmghZIH2cLmK1

docker run -i -t -d -p 31017:80 --restart=always \
    -v $PWD/app@runtime/doc-office/logs:/var/log/onlyoffice \
    -v $PWD/app@runtime/doc-office/data:/var/www/onlyoffice/Data \
    -v $PWD/app@runtime/doc-office/lib:/var/lib/onlyoffice \
    -v $PWD/app@runtime/doc-office/db:/var/lib/postgresql \
    -e JWT_SECRET=OaBgxq6UYs6IWBSHdUlMswUDmghZIH2cLmK1 onlyoffice/documentserver:latest
----

[NOTE]
====
若将 Docker 使用在生产环境，强烈建议将数据文件存储到容器之外，这种做法和使用 Docker 运行数据库是一个原理。而在Zero脚手架中，新的文档服务器的规划目录放到启动器的 `app@runtime/doc-office` 目录下，此处的目录基础规划如：

[options="header", cols="3,7"]
|====
|目录/文件|含义
|`<app>/app@runtime/doc-office` | 应用根目录，当前目录使用 `${PWD}` 环境变量可以得到**绝对路径**。
|`<app>/app@runtime/doc-office/logs` | 对应 `/var/log/onlyoffice` 日志数据。
|`<app>/app@runtime/doc-office/data` | 对应 `/var/www/onlyoffice/Data` 数据目录。
|`<app>/app@runtime/doc-office/lib` | 对应 `/var/lib/onlyoffice` 文件缓存。
|`<app>/app@runtime/doc-office/db` | 对应 `/var/lib/postgresql` 数据库文件。
|====
====

==== Docker-Compose

**开发推荐**：这种方式可以自己修改配置文件，然后使用 `docker-compose` 拉起 ONLYOFFICE 的服务，先下载库：

[source,bash]
----
git clone https://github.com/ONLYOFFICE/Docker-DocumentServer
----

修改项目中的 `docker-compose.yml` 配置文件（只更改端口号部分）

[source,yaml]
----
version: '2'
services:
  onlyoffice-documentserver:
    build:
      context: .
    container_name: onlyoffice-documentserver
    depends_on:
      - onlyoffice-postgresql
      - onlyoffice-rabbitmq
    environment:
      - DB_TYPE=postgres
      - DB_HOST=onlyoffice-postgresql
      - DB_PORT=5432
      - DB_NAME=onlyoffice
      - DB_USER=onlyoffice
      - AMQP_URI=amqp://guest:guest@onlyoffice-rabbitmq
      # Uncomment strings below to enable the JSON Web Token validation.
      #- JWT_ENABLED=true
      #- JWT_SECRET=secret
      #- JWT_HEADER=Authorization
      #- JWT_IN_BODY=true
    ports:
      - '20080:80'                      # 端口映射 20080 -> 80
      - '20443:443'                     # 端口映射 20443 -> 443
    stdin_open: true
    restart: always
    stop_grace_period: 60s
    volumes:
      - /var/www/onlyoffice/Data
      - /var/log/onlyoffice
      - /var/lib/onlyoffice/documentserver/App_Data/cache/files
      - /var/www/onlyoffice/documentserver-example/public/files
      - /usr/share/fonts

  onlyoffice-rabbitmq:
    container_name: onlyoffice-rabbitmq
    image: rabbitmq
    restart: always
    expose:
      - '5672'

  onlyoffice-postgresql:
    container_name: onlyoffice-postgresql
    image: postgres:9.5
    environment:
      - POSTGRES_DB=onlyoffice
      - POSTGRES_USER=onlyoffice
      - POSTGRES_HOST_AUTH_METHOD=trust
    restart: always
    expose:
      - '5432'
    volumes:
      - postgresql_data:/var/lib/postgresql

volumes:
  postgresql_data:
----

依次执行如下命令：

[source,bash]
----
# 进入目录中，docker-compose.yml 已改过
cd Docker-DocumentServer

# 然后拉起
docker-compose up -d

# 停止使用如下命令
docker-compose down
----

第一次由于镜像、依赖库下载等各种问题，速度会慢一点（保证您的网络连通性），执行过程中您可以看到如下截图：

image:zero-doc-docker-compose.png[,900]

==== Ubuntu

本章提供在 `Ubuntu` （ `Ubuntu Server 22.04.3 LTS` ）上安装的详细流程，此部分内容同时支持**开发环境/生产环境**。

[options="header", cols="4,6"]
|====
|项|需求
|`CPU` | `> 2GHz`
|`RAM`（内存） | `> 2GB`
|`HDD`（硬盘） | `> 40GB`
|`SWAP` | `> 4GB`
|`OS` | 内核版本超过 `3.13`（执行 `uname -a` 查看）
|其他库 a|

- `PostgreSQL > 12.9`
- `NGINX > 1.3.13`
- `libstdc++6 > 4.8.4`
- `RabbitMQ`
|====

[TIP]
====
前文中已经配置过 `ox.office.cn` 域名映射的IP地址，所以本章节所有的配置都配置到此域名下，推荐搭建环境时使用域名替换掉IP，不论是局域网DNS还是伪集群模式，使用域名是最好的方式，以防止IP地址变化导致配置的大规模更新。
====

由于实例运行在局域网中，安装配置之前先按如下步骤检查防火墙并关闭：

[source,bash]
----
# 查看防火墙状态
# inactive - 禁用
# active - 启用
sudo ufw status
# 禁用防火墙
sudo ufw disable
----

===== 依赖库

下边是安装 ONLYOFFICE 所需的依赖库：

[options="header", cols="4,6"]
|====
|库名|含义
|`libcurl3` |一个用于处理网络数据传输的开源库，它提供了一个简单的 API，允许开发人员通过多种协议（如HTTP、FTP、SCP、SFTP等）发送和接收数据。
|`libxml2` |libxml2 是一个用于解析和处理XML（可扩展标记语言）文档的开源库，libxml2 提供了一套功能强大的工具，用于读取、解析、创建和修改XML文档，使开发人员能够在各种应用程序中处理XML数据。
|`fonts-dejavu` |fonts-dejavu 是一个开源字体包，包含了 DejaVu 字体系列的字体文件，这些字体是基于 Bitstream Vera 字体系列的扩展，旨在提供广泛的字符集支持，包括拉丁字母、希腊字母、西里尔字母以及各种特殊字符和符号。
|`fonts-liberation` |fonts-liberation 是一个字体包，旨在提供一组兼容微软字体的开源替代品，这些字体与微软的字体（例如Times New Roman、Arial和Courier New）在外观和排版上非常相似，但它们是自由和开源的，可以在各种操作系统上自由使用、分发和修改。
|`ttf-mscorefonts-installer` |ttf-mscorefonts-installer 是一个用于在Linux系统上安装微软核心字体（Microsoft Core Fonts）的软件包，微软核心字体是一组由微软创建并在其操作系统中广泛使用的字体，包括常见的字体如Arial、Times New Roman、Courier New等。
|`fonts-crosextra-carlito` |fonts-crosextra-carlito 是一种字体包，提供了 Carlito 字体，这是对微软 Calibri 字体的开源替代品，Calibri 是一种常见的无衬线字体，通常用于文档和电子邮件等办公应用程序中。
|`fonts-takao-gothic` |fonts-takao-gothic 是一个字体包，包含了 Takao 字体家族的高丽字体（Gothic）变种。Takao 字体是一组用于支持多种亚洲语言字符集的开源字体。
|`fonts-opensymbol` |fonts-opensymbol 是一个字体包，包含了开源的 OpenSymbol 字体。OpenSymbol 字体是一种特殊的字体，用于显示各种符号、图标和特殊字符，通常与办公套件和文档处理软件一起使用。
|====

执行如下命令安装上述库：

[source,bash]
----
# 1. libcurl3 已经没有提供安装源了，所以此处使用 libcurl4 替换
# 2. 此处执行时需使用 sudo 提升权限
sudo apt install libcurl4 libxml2 fonts-dejavu fonts-liberation ttf-mscorefonts-installer fonts-crosextra-carlito fonts-takao-gothic fonts-opensymbol
----

[WARNING]
====
按照官方教程提及，若安装的是 `14.04 TLS` 或旧版本才需安装上述依赖库，但由于部分内容已经存在更新包，所以依旧执行一次上述命令，当您看到如下信息证明依赖库已全部安装完成：

image:zero-doc-dep.png[,800]
====

===== PostgreSQL

ONLYOFFICE 依赖 PgSQL 数据库，本章节提供 PgSQL 在 Ubuntu 上的安装。

1. 执行下边命令先安装 PgSQL 数据库：
+
--
[source,bash]
----
sudo apt-get install postgresql
----
--
2. 安装完成后，您需要为 ONLYOFFICE 初始化数据库：
+
--
[source,bash]
----
sudo -i -u postgres psql -c "CREATE USER onlyoffice WITH PASSWORD 'onlyoffice';"
sudo -i -u postgres psql -c "CREATE DATABASE onlyoffice OWNER onlyoffice;"
----
--
3. （局域网访问）编辑 PgSQL 的配置文件：
+
--
_1) `postgresql.conf` 编辑_

[source,bash]
----
sudo vim /etc/postgresql/14/main/postgresql.conf
----

找到配置文件中的如下配置，并更改：

[source,properties]
----
listen_addresses = '*'
----

_2) `pg_hba.conf` 编辑_

[source,bash]
----
sudo vim /etc/postgresql/14/main/pg_hba.conf
----

在配置文件末尾追加如下：

[source,properties]
----
# Local Network connect on [ADDRESS] section
host    all             all             0.0.0.0/0               scram-sha-256
----

_3）重启服务_

更改配置文件之后，执行如下命令：

[source,bash]
----
sudo systemctl restart postgresql
----
--
4. 打开数据库连接工具，并使用 `onlyoffice/onlyoffice` 账号密码访问（确认可连接即可）：
+
--
image:zero-doc-pg.png[,640]
--

===== RabbitMQ

RabbitMQ 是一个开源的消息队列中间件（Message Broker），它实现了高级消息队列协议（AMQP）的标准，消息队列是一种用于在不同的应用程序或组件之间传递消息的通信方式，它们通常用于解耦不同部分的应用程序，以便它们可以独立运行和扩展。

您可以按照如下步骤搭建 Ubuntu 上的 MQ：

1. 安装 RabbitMQ：
+
--
[source,bash]
----
sudo apt install rabbitmq-server
----
--
2. 若是 `18.04+` 的系统，还需额外执行如下命令：
+
--
[source,bash]
----
sudo apt install nginx-extras
----
--

===== ONLYOFFICE Docs

安装 Docs 之前，您需要先看看此产品的端口相关内容，参考如下表格（完整版参考：link:https://helpcenter.onlyoffice.com/installation/docs-community-open-ports.aspx[Ports List]）：

[options="header",cols="4,6"]
|====
|端口号 |服务
|80 |HTTP
|443 |HTTPS
|4369 |Erlang
|5432 |PostgreSQL
|5672 |RabbitMQ
|6379 |Redis
|8000 |DocService
|8080 |Spellchecker
|====

若您想要更改 **debconf** 系统的默认端口，则您可以执行如下命令：

[source,bash]
----
# Zero Framework 中推荐端口号 5600
echo onlyoffice-documentserver onlyoffice/ds-port select <PORT_NUMBER> | sudo debconf-set-selections
----

[WARNING]
====
如果您想将 ONLYOFFICE Docs 协议更改为 HTTPS，请不要将端口更改为 443，而是参考官方的专用说明：link:https://helpcenter.onlyoffice.com/installation/docs-community-https-linux.aspx[Switching to HTTPS Protocol]。
====

参考如下步骤安装 `Docs`：

1. 添加 `GPG Key`：
+
--
[source,bash]
----
mkdir -p -m 700 ~/.gnupg

curl -fsSL https://download.onlyoffice.com/GPG-KEY-ONLYOFFICE | gpg --no-default-keyring --keyring gnupg-ring:/tmp/onlyoffice.gpg --import

chmod 644 /tmp/onlyoffice.gpg

sudo chown root:root /tmp/onlyoffice.gpg

sudo mv /tmp/onlyoffice.gpg /usr/share/keyrings/onlyoffice.gpg
----
--
2. 追加 ONLYOFFICE Docs 的库：
+
--
[source,bash]
----
echo "deb [signed-by=/usr/share/keyrings/onlyoffice.gpg] https://download.onlyoffice.com/repo/debian squeeze main" | sudo tee /etc/apt/sources.list.d/onlyoffice.list
----
--
3. 更新包缓存：
+
--
[source,bash]
----
sudo apt update
----

image:zero-doc-deb.png[,800]
--
4. 执行如下命令安装
+
--
[source,bash]
----
# Fonts（依赖项部分已安装）
sudo apt install ttf-mscorefonts-installer

# OnlyOffice（安装过程要提供 PgSQL中的密码）
sudo apt install onlyoffice-documentserver
----
--

====
其他 Linux 版本如 CentOS 的安装流程，开发人员可参考官方文档和本章提到的步骤自行研究。
====

===== JWT

`ONLYOFFICE` 从 `7.2` 开始默认会开启 `JWT`，若您没有为它配置任何密钥 `secret`，那么它会随机生成一个密钥，若是使用 Docker 模式启动，您可以使用如下两个选项进行配置：

[options="header", cols="3,7"]
|====
|选项|含义
|`JWT_ENABLED` |是否开启 JWT，默认是 true，若想要关闭可以选择 false。
|`JWT_SECRET` |设置 JWT 的值，若此处不设置，则 `ONLYOFFICE` 会为它随机生成。
|====

安装完成之后，`secret` 会存储在配置文件 `/etc/onlyoffice/documentserver/local.json` 中，您可以检查属性 `services.CoAuthoring.secret.browser.string`。其中 `/etc/onlyoffice/documentserver/` 是 `ONLYOFFICE` 的配置目录，此目录中还有一个 `default.json` 的配置文件，根据官方的教程推荐，配置处理仅编辑 `local.json` 即可，不要直接编辑 `default.json` 文件的内容——每次重新启动 Docker 容器或升级 **文档服务器** 到新版本时都会恢复默认值，并且所有的更改都将丢失。参考如下示例（只和 JWT 相关的部分）：

[source,json]
----
{
    "services": {
        "CoAuthoring": {
            "secret": {
                "inbox": {
                    "string": "secret"
                },
                "outbox": {
                    "string": "secret"
                },
            },
            "token": {
                "enable": {
                    "browser": true,
                    "request": {
                        "inbox": true,
                        "outbox": true
                    }
                }
            }
        }
    }
}
----

配置 JWT 时需理解如下参数：

[options="header", cols="4,6"]
|====
|参数|含义
|`services.CoAuthoring.secret.browser.string` |「*Deprecated*」定义了在客户端浏览器请求ONLYOFFICE Docs生成令牌的秘钥。自版本 *7.2* 起请改用 `services.CoAuthoring.secret.inbox.string`。
|`services.CoAuthoring.secret.inbox.string` |自版本 *7.2* 起，该项定义了在来自文档存储服务到文档命令服务、文档转换服务和文档构建服务的传入HTTP请求中生成令牌的秘钥，以及在客户端浏览器请求ONLYOFFICE Docs时生成令牌的秘钥。
|`services.CoAuthoring.secret.outbox.string` |定义了用于在文档编辑服务发送的传出HTTP请求中生成令牌的秘钥，以供回调URL地址使用。
|`services.CoAuthoring.token.enable.browser` |定义客户端浏览器请求中的令牌是否启用。
|`services.CoAuthoring.token.enable.request.inbox` |定义传入的HTTP请求中的令牌是否启用。
|`services.CoAuthoring.token.enable.request.outbox` |定义传出的HTTP请求中的令牌是否启用。
|====

==== 验证结果

===== 基本环境

1. 修复配置，若您的配置有问题，可使用如下命令修复：
+
--

image:zero-doc-e-dpkg.png[,800]

[source,bash]
----
sudo dpkg --configure -a
# 下边是输出
Setting up onlyoffice-documentserver (7.4.1-36) ...
Generating AllFonts.js, please wait...Done
Generating presentation themes, please wait...Done
Generating js caches, please wait...Done
Installing plugins, please wait...
# 最后一个步骤十分慢，需要等待很久才可以
----
--

2. 浏览器打开：link:http://ox.office.cn:5600[] 地址，您可以看到如下界面，就基本证明：
+
--
image:zero-doc-ui.png[,900]
--

====
如此您就可以在前端使用 `Document Server` 了，高级配置可参考官方教程。
====

===== 诊断/调试

由于修改了配置之后您需要将整个服务重启才可以生效，本章节提供 ONLYOFFICE 的基本命令辅助**诊断/调试**。

1. 直接进入 `/var/log/onlyoffice/documentserver` 目录，此目录结构如下：
+
--
[options="header", cols="3,7"]
|====
|文件 |含义
|`converter/out.log` |Docs Converter 输出日志
|`converter/err.log` |Docs Converter 错误日志
|`docservice/out.log` |Docs Docservice 输出日志
|`docservice/err.log` |Docs Docservice 错误日志
|`metrics/out.log` |Docs Metrics 输出日志
|`metrics/err.log` |Docs Metrics 错误日志
|`nginx.error.log` |Nginx 错误日志
|====
-- 
2. 您可以使用如下命令查看后台服务的状态，默认情况只会安装 `Converter / Docservice / Metrics` 三个服务：
+
--
[source,bash]
----
# 所有 ONLYOFFICE 安装完成之后的服务都带有 ds- 前缀
systemctl status ds-*
----

image:zero-doc-service.png[,800]
--

3. 有了上述服务名称之后，您就可以直接使用下边的命令重启服务（大部分场景只需要重启 `ds-docservice` 服务即可）：
+
--
[source,bash]
----
sudo systemctl restart ds-metrics       # Metrics
sudo systemctl restart ds-docservice    # Docservice
sudo systemctl restart ds-converter     # Converter

# 参考官方提示
# RPM / DEB 软件包的重启
systemctl restart ds-*
# Docker 安装方式的重启
supervisorctl restart all
----
--


