ifndef::imagesdir[:imagesdir: ../images]
:data-uri:

=== 名空间[[__CONFIG_MODEL_NS]]

==== 名空间概述

名空间在 **动态建模** 过程中会直接影响 **模型、接口、服务、任务** 的所属，所以理解 Zero 建模过程中的名空间是十分有必要的，此部分内容会关联到高阶设计（AMS）中的抽象定义，开发人员必须熟悉。Zero 建模过程中的名空间的结构图如下：

image:mbse-ns.png[,900]

上述结构图描述了 **名空间、租户、应用、统一标识符** 在Zero全环境中的应用，从结构中可以看到名空间的解析流程：

1. 系统加载 SPI 读取接口 `io.horizon.spi.modeler.AtomNs` 的实现类。
2. 若您没有自定义 `AtomNs` 实现类，那么系统会使用默认的 `io.horizon.spi.modeler.AtomNsZero`：
+
--
默认流程如：

- 2.1. 从环境变量 `Z_NS` 中提取名空间前缀，提取不了使用默认前缀：`io.mature.{0}`。
- 2.2. 最终名空间格式如：`<namespace>.<appName>`。
- 2.3. 应用名称存在时则使用定义的应用名，不存在则使用 `aeon` 作为应用名。

所以若什么环境都没有配置时，直接使用 `io.mature.aeon` 作名空间（Zero内置默认值）。
--
3. `AtomNs` 提供了两个接口：
+
--
- 标准名空间：应用级专用概念。
- 模型唯一标识：根据名空间和模型的 `identifier` 计算的模型唯一标识符。
--

==== 应用模式

本章节再次讨论 Zero 中的几个核心划定边界的基本概念，应用边界在 `io.horizon.eon.em.EmApp` 类中的枚举变量 `Mode` 中定义：

[options="header",cols="1,1,1,1,6"]
|====
|Mode值|appId|tenantId|sigma|含义
|`CUBE`| 1 | 1 | `appId` | 「单租户」这种场景下 `sigma` 语义和 `appId` 维度对齐，目前大部分应用版本使用的是这种模式。
|`SPACE`| n | 1 | `tenantId` | 「多租户」这种场景下 `sigma` 语义和 `tenantId` 维度对齐，且支持多个应用。
|`GALAXY`| n | n | 无 | 「云租户」这种场景下 `sigma` 会管辖旗下所有的租户，形成平台租户场景。
|`FRONTIER`| ? | ? | ? |（保留设计）
|====

上述应用模式在新版中会包含 **多应用 / 单应用** 的支持，独立运行时可以根据不同的场景开应用，而名空间属于小维度应用模式，简单说根据实际情况您可以修改 `AtomNs` 来定义新的名空间算法以达到这个目的，完整的维度结构如下：

image:mbse-app-mode.png[0,900]

1. 名空间和应用的绑定只会存在：`1:1` 或 `1:N` 的情况，简单说和名空间相关的模型、接口、任务、服务等都只能隶属于 **应用范畴** 以支撑业务。
2. 租户 `tenant` / 语言 `language` / 统一标识 `sigma` 这三个维度为抽象维度，控制整个应用配置的变化。
3. `sigma` 是一个 **浮动维度**，它作为 **双结构设计** 中的备用数据结构支撑来辅助开发人员提供的第二维度查询条件，举个例子：当 `sigma` 和 `appId` 的维度等价时，那么按这两个维度查询的结果是一致的。

[CAUTION]
====
应用发布过程中不可以忽略的两个点在于：

1. 当开启了容器之后，容器的拆分点在 `namespace` 或 `appId` 这个级别，**独立容器** 是一个理想模式，一旦到了这个级别，上述所有的属性在 **应用级** 会变得十分鸡肋，但是在 **第二管理端** 会十分有用，作为监控、采集指标信息的维度参考。
2. **应用级** 会包含 **开发中心** 做应用内的定制，应用之外的定制在 **第二管理端** 完成，第二管理端功能如下：
+
--
- 容器监控：监控租户容器、指标容器等运行指标，包括提供日志管理平台对运行异常进行分析。
- 租户/资费/许可：和租户绑定的基础管理平台，用于管理单个租户在云端的基础业务（不牵涉应用）。
- 发布管理：初始化容器/应用、备份还原配置等针对应用的标准化发布管理操作。
--
====

==== 名空间设置

Zero 动态建模基于配置数据，最终模型数据是依靠 **导入** 的方式进入的系统，在这种场景下，有几个关于名空间的点需要设置：

1. 基础导入：
+
--
基础数据导入依赖初始化环境文件：

- 一层引用：`runtime/configuration.json` 文件中配置 `stellar` 查询真实环境文件，此环境文件和环境变量相互协同。
- 二层引用：`init/environment.json`（一层引用中的 `stellar` 值，此处为默认值）中配置 `global` 节点。

上述 `global` 节点的内容会在配置数据初始化过程中进库，参考如：

[source,json]
----
{
    "global": {
        "namespace": "???"
    }
}
----
--

2. 指令程序：
+
--
指令程序中的 `xxx-atom` 会负责导入建模配置信息，它在导入过程中底层会调用 `AtomNs` 来计算当前环境中的名空间，所以在环境变量文件中需要设置对应变量才可以：

[source,bash]
----
export DB_ATOM=cmdb
export Z_APP=vie.app.test
export Z_NS="cn.demo.{0}"
# 如此计算出来的名空间信息为：cn.demo.vie.app.test
----
--

上述两个地方就是 **名空间设置** 过程必须的内容。

[WARNING]
====
本章提到的两个点在于您没有自定义 `AtomNs`，若您使用 SPI 重新自定义过 `AtomNs`，那么本章节的规则就不适用了，至于具体如何实现名空间的提取您可以参考标准实现的代码。
====
